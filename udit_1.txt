IDENTIFICATION DIVISION.
       PROGRAM-ID. ACCTUPDT-REFACTORED.

       ENVIRONMENT DIVISION.
       INPUT-OUTPUT SECTION.
       FILE-CONTROL.
           SELECT ACCTMAST-IN    ASSIGN TO 'ACCTMAST.DAT'
               ORGANIZATION IS SEQUENTIAL.
           SELECT ACCTTRAN-IN    ASSIGN TO 'ACCTTRAN.DAT'
               ORGANIZATION IS SEQUENTIAL.
           SELECT ACCTMAST-OUT   ASSIGN TO 'ACCTMAST.NEW'
               ORGANIZATION IS SEQUENTIAL.
           SELECT AUDIT-REPORT   ASSIGN TO 'ACCTREP.TXT'
               ORGANIZATION IS SEQUENTIAL.

       DATA DIVISION.
       FILE SECTION.

       FD  ACCTMAST-IN.
       01  ACCTMAST-REC-IN.
           05  AMI-ACCT-NUMBER         PIC X(10).
           05  AMI-CUST-NAME           PIC X(30).
           05  AMI-BALANCE             PIC S9(9)V99 COMP-3.
           05  AMI-LAST-ACTIVITY-DATE  PIC 9(8).
           05  AMI-STATUS              PIC X(1).

       FD  ACCTTRAN-IN.
       01  ACCTTRAN-REC.
           05  T-ACCT-NUMBER           PIC X(10).
           05  T-TRAN-CODE             PIC X(2).
           05  T-TRAN-AMOUNT           PIC S9(7)V99 COMP-3.
           05  T-TRAN-DATE             PIC 9(8).

       FD  ACCTMAST-OUT.
       01  ACCTMAST-REC-OUT.
           05  AMO-ACCT-NUMBER         PIC X(10).
           05  AMO-CUST-NAME           PIC X(30).
           05  AMO-BALANCE             PIC S9(9)V99 COMP-3.
           05  AMO-LAST-ACTIVITY-DATE  PIC 9(8).
           05  AMO-STATUS              PIC X(1).

       FD  AUDIT-REPORT.
       01  AUDIT-REPORT-REC           PIC X(80).

       WORKING-STORAGE SECTION.
       77  WS-RUN-DATE                PIC 9(8) VALUE ZEROS.
       77  WS-EOF-MASTER              PIC X VALUE 'N'.
       77  WS-EOF-TRAN                PIC X VALUE 'N'.
       77  WS-TRAN-FOUND              PIC X VALUE 'N'.
       77  WS-UNKNOWN-TRAN            PIC X VALUE 'N'.
       77  WS-DETAIL-LINE             PIC X(80).
       77  WS-REPORT-LINE             PIC X(80).
       77  WS-TRAN-AMOUNT             PIC S9(7)V99 COMP-3 VALUE ZERO.
       77  WS-TRAN-CODE               PIC X(2).
       77  WS-TRAN-DATE               PIC 9(8).
       77  WS-ACCT-NUMBER             PIC X(10).
       77  WS-TRAN-ACCT-NUMBER        PIC X(10).
       77  WS-TRAN-APPLIED            PIC X VALUE 'N'.
       77  WS-NO-TRANSACTION          PIC X VALUE 'N'.

       01  WS-REPORT-TEXT.
           05  FILLER                 PIC X(15) VALUE SPACES.
           05  WS-RPT-ACCT-NUMBER     PIC X(10).
           05  FILLER                 PIC X(2)  VALUE SPACES.
           05  WS-RPT-CUST-NAME       PIC X(30).
           05  FILLER                 PIC X(2)  VALUE SPACES.
           05  WS-RPT-BALANCE         PIC ZZZ,ZZZ,ZZ9.99.
           05  FILLER                 PIC X(2)  VALUE SPACES.
           05  WS-RPT-STATUS          PIC X(15).

       01  FILLER.
           05  WS-TRAN-SEARCH-OVER    PIC X VALUE 'N'.

       PROCEDURE DIVISION.

       MAIN-LOGIC.
           PERFORM INIT-SECTION
           PERFORM PROCESS-ACCOUNTS
           PERFORM FINALIZE-SECTION
           STOP RUN.

       INIT-SECTION.
           OPEN INPUT ACCTMAST-IN
           OPEN INPUT ACCTTRAN-IN
           OPEN OUTPUT ACCTMAST-OUT
           OPEN OUTPUT AUDIT-REPORT
           PERFORM SET-RUN-DATE
           PERFORM READ-MASTER
           PERFORM READ-TRANSACTION
           .

       SET-RUN-DATE.
           * Set run date (original code had hardcoded date)
           ACCEPT WS-RUN-DATE FROM DATE YYYYMMDD
           .

       PROCESS-ACCOUNTS.
           PERFORM UNTIL WS-EOF-MASTER = 'Y'
               MOVE 'N' TO WS-TRAN-FOUND
               MOVE 'N' TO WS-UNKNOWN-TRAN
               MOVE 'N' TO WS-NO-TRANSACTION
               PERFORM MATCH-AND-APPLY-TRANSACTIONS
               IF WS-TRAN-FOUND = 'N'
                   PERFORM FLAG-NO-TRANSACTION
               END-IF
               PERFORM WRITE-UPDATED-MASTER
               PERFORM WRITE-AUDIT-DETAIL
               PERFORM READ-MASTER
           END-PERFORM
           .

       MATCH-AND-APPLY-TRANSACTIONS.
           * For each master record, apply all matching transactions
           PERFORM UNTIL WS-EOF-TRAN = 'Y'
               IF T-ACCT-NUMBER = AMI-ACCT-NUMBER
                   MOVE 'Y' TO WS-TRAN-FOUND
                   MOVE T-TRAN-CODE TO WS-TRAN-CODE
                   MOVE T-TRAN-AMOUNT TO WS-TRAN-AMOUNT
                   MOVE T-TRAN-DATE TO WS-TRAN-DATE
                   PERFORM APPLY-TRANSACTION
                   PERFORM READ-TRANSACTION
               ELSE
                   IF T-ACCT-NUMBER > AMI-ACCT-NUMBER
                       EXIT PERFORM
                   ELSE
                       PERFORM READ-TRANSACTION
                   END-IF
               END-IF
           END-PERFORM
           .

       APPLY-TRANSACTION.
           EVALUATE WS-TRAN-CODE
               WHEN '01'
                   ADD WS-TRAN-AMOUNT TO AMI-BALANCE
                   MOVE WS-TRAN-DATE TO AMI-LAST-ACTIVITY-DATE
                   MOVE SPACE TO WS-RPT-STATUS
               WHEN '02'
                   SUBTRACT WS-TRAN-AMOUNT FROM AMI-BALANCE
                   MOVE WS-TRAN-DATE TO AMI-LAST-ACTIVITY-DATE
                   MOVE SPACE TO WS-RPT-STATUS
               WHEN '03'
                   SUBTRACT WS-TRAN-AMOUNT FROM AMI-BALANCE
                   MOVE WS-TRAN-DATE TO AMI-LAST-ACTIVITY-DATE
                   MOVE 'FEE APPLIED' TO WS-RPT-STATUS
               WHEN OTHER
                   MOVE 'Y' TO WS-UNKNOWN-TRAN
                   MOVE 'UNKNOWN TRAN CODE' TO WS-RPT-STATUS
           END-EVALUATE
           .

       FLAG-NO-TRANSACTION.
           MOVE 'Y' TO WS-NO-TRANSACTION
           MOVE 'NO TRANSACTIONS' TO WS-RPT-STATUS
           .

       WRITE-UPDATED-MASTER.
           MOVE AMI-ACCT-NUMBER        TO AMO-ACCT-NUMBER
           MOVE AMI-CUST-NAME          TO AMO-CUST-NAME
           MOVE AMI-BALANCE            TO AMO-BALANCE
           MOVE AMI-LAST-ACTIVITY-DATE TO AMO-LAST-ACTIVITY-DATE
           MOVE AMI-STATUS             TO AMO-STATUS
           WRITE ACCTMAST-REC-OUT
           .

       WRITE-AUDIT-DETAIL.
           MOVE AMI-ACCT-NUMBER TO WS-RPT-ACCT-NUMBER
           MOVE AMI-CUST-NAME   TO WS-RPT-CUST-NAME
           MOVE AMI-BALANCE     TO WS-RPT-BALANCE
           IF WS-UNKNOWN-TRAN = 'Y'
               MOVE 'UNKNOWN TRAN CODE' TO WS-RPT-STATUS
           ELSE
               IF WS-NO-TRANSACTION = 'Y'
                   MOVE 'NO TRANSACTIONS' TO WS-RPT-STATUS
               END-IF
           END-IF
           STRING
               WS-RPT-ACCT-NUMBER DELIMITED BY SIZE
               '  ' DELIMITED BY SIZE
               WS-RPT-CUST-NAME DELIMITED BY SIZE
               '  ' DELIMITED BY SIZE
               WS-RPT-BALANCE DELIMITED BY SIZE
               '  ' DELIMITED BY SIZE
               WS-RPT-STATUS DELIMITED BY SIZE
               INTO WS-DETAIL-LINE
           END-STRING
           MOVE WS-DETAIL-LINE TO AUDIT-REPORT-REC
           WRITE AUDIT-REPORT-REC
           .

       READ-MASTER.
           READ ACCTMAST-IN INTO ACCTMAST-REC-IN
               AT END
                   MOVE 'Y' TO WS-EOF-MASTER
           END-READ
           .

       READ-TRANSACTION.
           READ ACCTTRAN-IN INTO ACCTTRAN-REC
               AT END
                   MOVE 'Y' TO WS-EOF-TRAN
           END-READ
           .

       FINALIZE-SECTION.
           CLOSE ACCTMAST-IN
           CLOSE ACCTTRAN-IN
           CLOSE ACCTMAST-OUT
           CLOSE AUDIT-REPORT
           .

       END PROGRAM ACCTUPDT-REFACTORED.
