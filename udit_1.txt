IDENTIFICATION DIVISION.
       PROGRAM-ID. ACCTUPDT-REFACTORED.

       ENVIRONMENT DIVISION.
       INPUT-OUTPUT SECTION.
       FILE-CONTROL.
           SELECT MASTER-FILE ASSIGN TO 'ACCTMAST.DAT'
               ORGANIZATION IS LINE SEQUENTIAL.
           SELECT TRAN-FILE ASSIGN TO 'ACCTTRAN.DAT'
               ORGANIZATION IS LINE SEQUENTIAL.
           SELECT NEW-MASTER-FILE ASSIGN TO 'ACCTMAST.NEW'
               ORGANIZATION IS LINE SEQUENTIAL.
           SELECT REPORT-FILE ASSIGN TO 'ACCTREP.TXT'
               ORGANIZATION IS LINE SEQUENTIAL.

       DATA DIVISION.
       FILE SECTION.

       FD  MASTER-FILE.
       01  MASTER-REC.
           05  M-ACCT-NUMBER         PIC X(10).
           05  M-NAME                PIC X(30).
           05  M-BALANCE             PIC S9(9)V99 COMP-3.
           05  M-LAST-ACTIVITY-DATE  PIC 9(8).
           05  FILLER                PIC X(2).

       FD  TRAN-FILE.
       01  TRAN-REC.
           05  T-ACCT-NUMBER         PIC X(10).
           05  T-TRAN-CODE           PIC XX.
           05  T-AMOUNT              PIC S9(7)V99 COMP-3.
           05  T-TRAN-DATE           PIC 9(8).
           05  FILLER                PIC X(2).

       FD  NEW-MASTER-FILE.
       01  NEW-MASTER-REC           PIC X(52).

       FD  REPORT-FILE.
       01  REPORT-REC               PIC X(80).

       WORKING-STORAGE SECTION.
       77  WS-RUN-DATE              PIC 9(8).
       77  WS-EOF-MASTER            PIC X VALUE 'N'.
       77  WS-EOF-TRAN              PIC X VALUE 'N'.
       77  WS-TRAN-FOUND            PIC X VALUE 'N'.
       77  WS-UNKNOWN-TRAN-CODE     PIC X VALUE 'N'.
       77  WS-REPORT-LINE           PIC X(80).
       77  WS-UPDATE-BALANCE        PIC S9(9)V99 COMP-3.
       77  WS-UPDATE-ACTIVITY-DATE  PIC 9(8).
       77  WS-TRAN-AMOUNT           PIC S9(7)V99 COMP-3.
       77  WS-TRAN-CODE             PIC XX.

       01  WS-REPORT-DETAIL.
           05  WS-RPT-ACCT-NUMBER   PIC X(10).
           05  WS-RPT-NAME          PIC X(30).
           05  WS-RPT-TRAN-CODE     PIC XX.
           05  WS-RPT-AMOUNT        PIC -ZZZZZZ9.99.
           05  WS-RPT-BALANCE       PIC -ZZZZZZZZ9.99.
           05  WS-RPT-STATUS        PIC X(20).

       01  WS-TRANSACTION-FOUND     PIC X VALUE 'N'.

       PROCEDURE DIVISION.

       MAIN-LOGIC.
           PERFORM INIT-SECTION
           PERFORM PROCESS-MASTER-RECORDS
           PERFORM FINALIZE-SECTION
           STOP RUN.

       INIT-SECTION.
           * Initialize run date (should be parameterized in future)
           MOVE 20241201 TO WS-RUN-DATE
           OPEN INPUT MASTER-FILE
           OPEN INPUT TRAN-FILE
           OPEN OUTPUT NEW-MASTER-FILE
           OPEN OUTPUT REPORT-FILE
           PERFORM READ-MASTER-RECORD
           PERFORM READ-TRAN-RECORD
           .

       PROCESS-MASTER-RECORDS.
           PERFORM UNTIL WS-EOF-MASTER = 'Y'
               PERFORM PROCESS-SINGLE-MASTER
               PERFORM READ-MASTER-RECORD
           END-PERFORM
           .

       PROCESS-SINGLE-MASTER.
           MOVE 'N' TO WS-TRANSACTION-FOUND
           PERFORM PROCESS-TRANSACTIONS-FOR-ACCOUNT
           IF WS-TRANSACTION-FOUND = 'Y'
               PERFORM WRITE-UPDATED-MASTER
           ELSE
               PERFORM REPORT-NO-TRANSACTION
               PERFORM WRITE-UNTOUCHED-MASTER
           END-IF
           .

       PROCESS-TRANSACTIONS-FOR-ACCOUNT.
           * Process all transactions for current master account
           PERFORM UNTIL WS-EOF-TRAN = 'Y'
               IF T-ACCT-NUMBER = M-ACCT-NUMBER
                   MOVE 'Y' TO WS-TRANSACTION-FOUND
                   MOVE T-TRAN-CODE TO WS-TRAN-CODE
                   MOVE T-AMOUNT TO WS-TRAN-AMOUNT
                   PERFORM APPLY-TRANSACTION
                   PERFORM REPORT-DETAIL
                   PERFORM READ-TRAN-RECORD
               ELSE
                   IF T-ACCT-NUMBER > M-ACCT-NUMBER
                       EXIT PERFORM
                   ELSE
                       PERFORM READ-TRAN-RECORD
                   END-IF
               END-IF
           END-PERFORM
           .

       APPLY-TRANSACTION.
           EVALUATE WS-TRAN-CODE
               WHEN '01'
                   PERFORM APPLY-DEPOSIT
               WHEN '02'
                   PERFORM APPLY-WITHDRAWAL
               WHEN '03'
                   PERFORM APPLY-FEE
               WHEN OTHER
                   MOVE 'Y' TO WS-UNKNOWN-TRAN-CODE
                   PERFORM REPORT-UNKNOWN-TRANSACTION
           END-EVALUATE
           .

       APPLY-DEPOSIT.
           ADD WS-TRAN-AMOUNT TO M-BALANCE
           MOVE T-TRAN-DATE TO M-LAST-ACTIVITY-DATE
           MOVE 'N' TO WS-UNKNOWN-TRAN-CODE
           .

       APPLY-WITHDRAWAL.
           SUBTRACT WS-TRAN-AMOUNT FROM M-BALANCE
           MOVE T-TRAN-DATE TO M-LAST-ACTIVITY-DATE
           MOVE 'N' TO WS-UNKNOWN-TRAN-CODE
           .

       APPLY-FEE.
           SUBTRACT WS-TRAN-AMOUNT FROM M-BALANCE
           MOVE T-TRAN-DATE TO M-LAST-ACTIVITY-DATE
           MOVE 'N' TO WS-UNKNOWN-TRAN-CODE
           .

       REPORT-DETAIL.
           MOVE M-ACCT-NUMBER TO WS-RPT-ACCT-NUMBER
           MOVE M-NAME TO WS-RPT-NAME
           MOVE WS-TRAN-CODE TO WS-RPT-TRAN-CODE
           MOVE WS-TRAN-AMOUNT TO WS-RPT-AMOUNT
           MOVE M-BALANCE TO WS-RPT-BALANCE
           IF WS-UNKNOWN-TRAN-CODE = 'Y'
               MOVE 'UNKNOWN TRAN CODE' TO WS-RPT-STATUS
           ELSE
               MOVE 'UPDATED' TO WS-RPT-STATUS
           END-IF
           PERFORM WRITE-REPORT-LINE
           .

       REPORT-UNKNOWN-TRANSACTION.
           MOVE M-ACCT-NUMBER TO WS-RPT-ACCT-NUMBER
           MOVE M-NAME TO WS-RPT-NAME
           MOVE WS-TRAN-CODE TO WS-RPT-TRAN-CODE
           MOVE WS-TRAN-AMOUNT TO WS-RPT-AMOUNT
           MOVE M-BALANCE TO WS-RPT-BALANCE
           MOVE 'UNKNOWN TRAN CODE' TO WS-RPT-STATUS
           PERFORM WRITE-REPORT-LINE
           .

       REPORT-NO-TRANSACTION.
           MOVE M-ACCT-NUMBER TO WS-RPT-ACCT-NUMBER
           MOVE M-NAME TO WS-RPT-NAME
           MOVE SPACES TO WS-RPT-TRAN-CODE
           MOVE ZERO TO WS-RPT-AMOUNT
           MOVE M-BALANCE TO WS-RPT-BALANCE
           MOVE 'NO TRANSACTION' TO WS-RPT-STATUS
           PERFORM WRITE-REPORT-LINE
           .

       WRITE-REPORT-LINE.
           STRING
               WS-RPT-ACCT-NUMBER DELIMITED BY SIZE
               ' ' DELIMITED BY SIZE
               WS-RPT-NAME DELIMITED BY SIZE
               ' ' DELIMITED BY SIZE
               WS-RPT-TRAN-CODE DELIMITED BY SIZE
               ' ' DELIMITED BY SIZE
               WS-RPT-AMOUNT DELIMITED BY SIZE
               ' ' DELIMITED BY SIZE
               WS-RPT-BALANCE DELIMITED BY SIZE
               ' ' DELIMITED BY SIZE
               WS-RPT-STATUS DELIMITED BY SIZE
               INTO WS-REPORT-LINE
           END-STRING
           WRITE REPORT-REC FROM WS-REPORT-LINE
           .

       WRITE-UPDATED-MASTER.
           MOVE MASTER-REC TO NEW-MASTER-REC
           WRITE NEW-MASTER-REC
           .

       WRITE-UNTOUCHED-MASTER.
           MOVE MASTER-REC TO NEW-MASTER-REC
           WRITE NEW-MASTER-REC
           .

       READ-MASTER-RECORD.
           READ MASTER-FILE
               AT END MOVE 'Y' TO WS-EOF-MASTER
           END-READ
           .

       READ-TRAN-RECORD.
           READ TRAN-FILE
               AT END MOVE 'Y' TO WS-EOF-TRAN
           END-READ
           .

       FINALIZE-SECTION.
           CLOSE MASTER-FILE
           CLOSE TRAN-FILE
           CLOSE NEW-MASTER-FILE
           CLOSE REPORT-FILE
           .

       END PROGRAM ACCTUPDT-REFACTORED.
