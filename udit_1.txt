IDENTIFICATION DIVISION.
       PROGRAM-ID. ACCTUPDT-REFACTORED.

       ENVIRONMENT DIVISION.
       INPUT-OUTPUT SECTION.
       FILE-CONTROL.
           SELECT ACCTMAST-INFILE ASSIGN TO 'ACCTMAST.DAT'
               ORGANIZATION IS LINE SEQUENTIAL.
           SELECT ACCTTRAN-INFILE ASSIGN TO 'ACCTTRAN.DAT'
               ORGANIZATION IS LINE SEQUENTIAL.
           SELECT ACCTMAST-OUTFILE ASSIGN TO 'ACCTMAST.NEW'
               ORGANIZATION IS LINE SEQUENTIAL.
           SELECT AUDIT-REPORT ASSIGN TO 'ACCTREP.TXT'
               ORGANIZATION IS LINE SEQUENTIAL.

       DATA DIVISION.
       FILE SECTION.

       FD  ACCTMAST-INFILE.
       01  ACCTMAST-REC.
           05  M-ACCT-NUMBER         PIC X(10).
           05  M-NAME                PIC X(30).
           05  M-BALANCE             PIC S9(9)V99 COMP-3.
           05  M-LAST-ACTIVITY-DATE  PIC 9(8).
           05  FILLER                PIC X(2).

       FD  ACCTTRAN-INFILE.
       01  ACCTTRAN-REC.
           05  T-ACCT-NUMBER         PIC X(10).
           05  T-TRAN-CODE           PIC XX.
           05  T-AMOUNT              PIC S9(7)V99 COMP-3.
           05  T-DATE                PIC 9(8).
           05  FILLER                PIC X(10).

       FD  ACCTMAST-OUTFILE.
       01  NEW-ACCTMAST-REC.
           05  N-ACCT-NUMBER         PIC X(10).
           05  N-NAME                PIC X(30).
           05  N-BALANCE             PIC S9(9)V99 COMP-3.
           05  N-LAST-ACTIVITY-DATE  PIC 9(8).
           05  FILLER                PIC X(2).

       FD  AUDIT-REPORT.
       01  AUDIT-REPORT-REC         PIC X(80).

       WORKING-STORAGE SECTION.

       77  WS-RUN-DATE              PIC 9(8) VALUE ZEROS.
       77  WS-EOF-MASTER            PIC X VALUE 'N'.
       77  WS-EOF-TRAN              PIC X VALUE 'N'.
       77  WS-ACCTS-PROCESSED       PIC 9(6) VALUE ZEROS.
       77  WS-ACCTS-UPDATED         PIC 9(6) VALUE ZEROS.
       77  WS-ACCTS-NO-TRAN         PIC 9(6) VALUE ZEROS.

       01  WS-TRANSACTION-FOUND     PIC X VALUE 'N'.
       01  WS-TRANSACTION-APPLIED   PIC X VALUE 'N'.
       01  WS-TRAN-CODE-DESC        PIC X(20).

       01  WS-REPORT-LINE           PIC X(80).

       01  WS-TOTAL-DEPOSIT         PIC S9(11)V99 COMP-3 VALUE ZEROS.
       01  WS-TOTAL-WITHDRAWAL      PIC S9(11)V99 COMP-3 VALUE ZEROS.
       01  WS-TOTAL-FEE             PIC S9(11)V99 COMP-3 VALUE ZEROS.

       01  WS-TRAN-ACCT-NUMBER      PIC X(10).
       01  WS-TRAN-CODE             PIC XX.
       01  WS-TRAN-AMOUNT           PIC S9(7)V99 COMP-3.
       01  WS-TRAN-DATE             PIC 9(8).

       01  WS-DETAIL-LINE           PIC X(80).

       PROCEDURE DIVISION.

       MAIN-LOGIC.
           PERFORM INIT-SECTION
           PERFORM PROCESS-ACCOUNTS
           PERFORM WRITE-SUMMARY-REPORT
           PERFORM FINALIZE-SECTION
           STOP RUN.

       INIT-SECTION.
           OPEN INPUT ACCTMAST-INFILE
           OPEN INPUT ACCTTRAN-INFILE
           OPEN OUTPUT ACCTMAST-OUTFILE
           OPEN OUTPUT AUDIT-REPORT
           PERFORM SET-RUN-DATE
           MOVE 'N' TO WS-EOF-MASTER
           MOVE 'N' TO WS-EOF-TRAN
           MOVE ZEROS TO WS-ACCTS-PROCESSED
           MOVE ZEROS TO WS-ACCTS-UPDATED
           MOVE ZEROS TO WS-ACCTS-NO-TRAN
           PERFORM READ-NEXT-MASTER
           PERFORM READ-NEXT-TRANSACTION.

       SET-RUN-DATE.
           ACCEPT WS-RUN-DATE FROM DATE YYYYMMDD.

       PROCESS-ACCOUNTS.
           PERFORM UNTIL WS-EOF-MASTER = 'Y'
               MOVE 'N' TO WS-TRANSACTION-FOUND
               PERFORM MATCH-AND-APPLY-TRANSACTIONS
               IF WS-TRANSACTION-FOUND = 'Y'
                   ADD 1 TO WS-ACCTS-UPDATED
               ELSE
                   PERFORM HANDLE-NO-TRANSACTION
               END-IF
               ADD 1 TO WS-ACCTS-PROCESSED
               PERFORM WRITE-NEW-MASTER-RECORD
               PERFORM READ-NEXT-MASTER
           END-PERFORM.

       MATCH-AND-APPLY-TRANSACTIONS.
           MOVE 'N' TO WS-TRANSACTION-APPLIED
           PERFORM UNTIL WS-EOF-TRAN = 'Y'
               IF T-ACCT-NUMBER = M-ACCT-NUMBER
                   MOVE 'Y' TO WS-TRANSACTION-FOUND
                   PERFORM APPLY-TRANSACTION
                   PERFORM PRINT-DETAIL-REPORT
                   PERFORM READ-NEXT-TRANSACTION
               ELSE
                   IF T-ACCT-NUMBER > M-ACCT-NUMBER
                       EXIT PERFORM
                   ELSE
                       PERFORM READ-NEXT-TRANSACTION
                   END-IF
               END-IF
           END-PERFORM.

       APPLY-TRANSACTION.
           EVALUATE T-TRAN-CODE
               WHEN '01'
                   ADD T-AMOUNT TO M-BALANCE
                   MOVE 'DEPOSIT APPLIED' TO WS-TRAN-CODE-DESC
                   ADD T-AMOUNT TO WS-TOTAL-DEPOSIT
                   MOVE 'Y' TO WS-TRANSACTION-APPLIED
               WHEN '02'
                   SUBTRACT T-AMOUNT FROM M-BALANCE
                   MOVE 'WITHDRAWAL APPLIED' TO WS-TRAN-CODE-DESC
                   ADD T-AMOUNT TO WS-TOTAL-WITHDRAWAL
                   MOVE 'Y' TO WS-TRANSACTION-APPLIED
               WHEN '03'
                   SUBTRACT T-AMOUNT FROM M-BALANCE
                   MOVE 'FEE APPLIED' TO WS-TRAN-CODE-DESC
                   ADD T-AMOUNT TO WS-TOTAL-FEE
                   MOVE 'Y' TO WS-TRANSACTION-APPLIED
               WHEN OTHER
                   MOVE 'UNKNOWN TRAN CODE' TO WS-TRAN-CODE-DESC
           END-EVALUATE
           IF WS-TRANSACTION-APPLIED = 'Y'
               MOVE WS-RUN-DATE TO M-LAST-ACTIVITY-DATE
           END-IF.

       HANDLE-NO-TRANSACTION.
           ADD 1 TO WS-ACCTS-NO-TRAN
           MOVE 'NO TRANSACTIONS' TO WS-TRAN-CODE-DESC
           PERFORM PRINT-NO-TRAN-DETAIL.

       PRINT-DETAIL-REPORT.
           STRING
               M-ACCT-NUMBER DELIMITED BY SIZE
               ' ' DELIMITED BY SIZE
               M-NAME DELIMITED BY SIZE
               ' ' DELIMITED BY SIZE
               WS-TRAN-CODE-DESC DELIMITED BY SIZE
               ' ' DELIMITED BY SIZE
               T-AMOUNT DELIMITED BY SIZE
               ' ' DELIMITED BY SIZE
               M-BALANCE DELIMITED BY SIZE
               ' ' DELIMITED BY SIZE
               WS-RUN-DATE DELIMITED BY SIZE
               INTO WS-DETAIL-LINE
           END-STRING
           MOVE WS-DETAIL-LINE TO AUDIT-REPORT-REC
           WRITE AUDIT-REPORT-REC.

       PRINT-NO-TRAN-DETAIL.
           STRING
               M-ACCT-NUMBER DELIMITED BY SIZE
               ' ' DELIMITED BY SIZE
               M-NAME DELIMITED BY SIZE
               ' ' DELIMITED BY SIZE
               WS-TRAN-CODE-DESC DELIMITED BY SIZE
               ' ' DELIMITED BY SIZE
               M-BALANCE DELIMITED BY SIZE
               ' ' DELIMITED BY SIZE
               WS-RUN-DATE DELIMITED BY SIZE
               INTO WS-DETAIL-LINE
           END-STRING
           MOVE WS-DETAIL-LINE TO AUDIT-REPORT-REC
           WRITE AUDIT-REPORT-REC.

       WRITE-NEW-MASTER-RECORD.
           MOVE M-ACCT-NUMBER        TO N-ACCT-NUMBER
           MOVE M-NAME               TO N-NAME
           MOVE M-BALANCE            TO N-BALANCE
           MOVE M-LAST-ACTIVITY-DATE TO N-LAST-ACTIVITY-DATE
           WRITE NEW-ACCTMAST-REC.

       READ-NEXT-MASTER.
           READ ACCTMAST-INFILE INTO ACCTMAST-REC
               AT END
                   MOVE 'Y' TO WS-EOF-MASTER
           END-READ.

       READ-NEXT-TRANSACTION.
           READ ACCTTRAN-INFILE INTO ACCTTRAN-REC
               AT END
                   MOVE 'Y' TO WS-EOF-TRAN
           END-READ.

       WRITE-SUMMARY-REPORT.
           MOVE SPACES TO WS-REPORT-LINE
           STRING
               'ACCOUNTS PROCESSED: ' DELIMITED BY SIZE
               WS-ACCTS-PROCESSED DELIMITED BY SIZE
               '  UPDATED: ' DELIMITED BY SIZE
               WS-ACCTS-UPDATED DELIMITED BY SIZE
               '  NO TRANSACTIONS: ' DELIMITED BY SIZE
               WS-ACCTS-NO-TRAN DELIMITED BY SIZE
               INTO WS-REPORT-LINE
           END-STRING
           MOVE WS-REPORT-LINE TO AUDIT-REPORT-REC
           WRITE AUDIT-REPORT-REC.

           MOVE SPACES TO WS-REPORT-LINE
           STRING
               'TOTAL DEPOSIT: ' DELIMITED BY SIZE
               WS-TOTAL-DEPOSIT DELIMITED BY SIZE
               '  TOTAL WITHDRAWAL: ' DELIMITED BY SIZE
               WS-TOTAL-WITHDRAWAL DELIMITED BY SIZE
               '  TOTAL FEE: ' DELIMITED BY SIZE
               WS-TOTAL-FEE DELIMITED BY SIZE
               INTO WS-REPORT-LINE
           END-STRING
           MOVE WS-REPORT-LINE TO AUDIT-REPORT-REC
           WRITE AUDIT-REPORT-REC.

       FINALIZE-SECTION.
           CLOSE ACCTMAST-INFILE
           CLOSE ACCTTRAN-INFILE
           CLOSE ACCTMAST-OUTFILE
           CLOSE AUDIT-REPORT.
