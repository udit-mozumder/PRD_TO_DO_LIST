IDENTIFICATION DIVISION.
       PROGRAM-ID. ACCTUPDT-REFACTORED.

       ENVIRONMENT DIVISION.
       CONFIGURATION SECTION.

       INPUT-OUTPUT SECTION.
       FILE-CONTROL.
           SELECT ACCT-MASTER-IN ASSIGN TO 'ACCTMAST.DAT'
               ORGANIZATION IS LINE SEQUENTIAL.
           SELECT ACCT-TRAN-IN ASSIGN TO 'ACCTTRAN.DAT'
               ORGANIZATION IS LINE SEQUENTIAL.
           SELECT ACCT-MASTER-OUT ASSIGN TO 'ACCTMAST.NEW'
               ORGANIZATION IS LINE SEQUENTIAL.
           SELECT ACCT-REPORT-OUT ASSIGN TO 'ACCTREP.TXT'
               ORGANIZATION IS LINE SEQUENTIAL.

       DATA DIVISION.
       FILE SECTION.

       FD  ACCT-MASTER-IN.
       01  ACCT-MASTER-REC.
           05  M-ACCT-NO         PIC X(10).
           05  M-NAME            PIC X(30).
           05  M-BALANCE         PIC S9(9)V99 COMP-3.
           05  M-LAST-ACT-DATE   PIC 9(8).
           05  FILLER            PIC X(2).

       FD  ACCT-TRAN-IN.
       01  ACCT-TRAN-REC.
           05  T-ACCT-NO         PIC X(10).
           05  T-TRAN-CD         PIC XX.
           05  T-TRAN-AMT        PIC S9(7)V99 COMP-3.
           05  T-TRAN-DATE       PIC 9(8).
           05  FILLER            PIC X(2).

       FD  ACCT-MASTER-OUT.
       01  ACCT-MASTER-OUT-REC  PIC X(52).

       FD  ACCT-REPORT-OUT.
       01  ACCT-REPORT-REC      PIC X(80).

       WORKING-STORAGE SECTION.

       77  WS-RUN-DATE          PIC 9(8) VALUE ZEROS.
       77  WS-EOF-MASTER        PIC X VALUE 'N'.
       77  WS-EOF-TRAN          PIC X VALUE 'N'.
       77  WS-UPDATED-ACCTS     PIC 9(6) VALUE ZERO.
       77  WS-NO-TRAN-ACCTS     PIC 9(6) VALUE ZERO.
       77  WS-TOTAL-ACCTS       PIC 9(6) VALUE ZERO.

       01  WS-REPORT-LINE.
           05  WS-RPT-ACCT-NO   PIC X(10).
           05  WS-RPT-NAME      PIC X(30).
           05  WS-RPT-BAL       PIC -ZZZZZZ9.99.
           05  WS-RPT-STATUS    PIC X(20).
           05  WS-RPT-DATE      PIC X(8).

       01  WS-TRANSACTION-FOUND    PIC X VALUE 'N'.

       01  WS-TRAN-ACCT-NO         PIC X(10).
       01  WS-TRAN-TRAN-CD         PIC XX.
       01  WS-TRAN-TRAN-AMT        PIC S9(7)V99 COMP-3.
       01  WS-TRAN-TRAN-DATE       PIC 9(8).

       PROCEDURE DIVISION.

       MAIN-LOGIC.
           PERFORM INIT-SECTION
           PERFORM PROCESS-MASTER-RECORDS
           PERFORM FINALIZE-SECTION
           STOP RUN.

       INIT-SECTION.
           OPEN INPUT ACCT-MASTER-IN
           OPEN INPUT ACCT-TRAN-IN
           OPEN OUTPUT ACCT-MASTER-OUT
           OPEN OUTPUT ACCT-REPORT-OUT
           PERFORM GET-RUN-DATE
           PERFORM READ-TRANSACTION
           PERFORM READ-MASTER.

       GET-RUN-DATE.
           ACCEPT WS-RUN-DATE FROM DATE YYYYMMDD.

       READ-MASTER.
           READ ACCT-MASTER-IN
               AT END MOVE 'Y' TO WS-EOF-MASTER
               NOT AT END ADD 1 TO WS-TOTAL-ACCTS.

       READ-TRANSACTION.
           READ ACCT-TRAN-IN
               AT END MOVE 'Y' TO WS-EOF-TRAN
               NOT AT END
                   MOVE T-ACCT-NO TO WS-TRAN-ACCT-NO
                   MOVE T-TRAN-CD TO WS-TRAN-TRAN-CD
                   MOVE T-TRAN-AMT TO WS-TRAN-TRAN-AMT
                   MOVE T-TRAN-DATE TO WS-TRAN-TRAN-DATE.

       PROCESS-MASTER-RECORDS.
           PERFORM UNTIL WS-EOF-MASTER = 'Y'
               PERFORM PROCESS-SINGLE-MASTER
               PERFORM READ-MASTER
           END-PERFORM.

       PROCESS-SINGLE-MASTER.
           MOVE 'N' TO WS-TRANSACTION-FOUND
           PERFORM APPLY-TRANSACTIONS
           IF WS-TRANSACTION-FOUND = 'Y'
               ADD 1 TO WS-UPDATED-ACCTS
           ELSE
               ADD 1 TO WS-NO-TRAN-ACCTS
               PERFORM REPORT-NO-TRANSACTION
           END-IF
           PERFORM WRITE-MASTER-OUT.

       APPLY-TRANSACTIONS.
           PERFORM UNTIL WS-EOF-TRAN = 'Y'
               IF WS-TRAN-ACCT-NO = M-ACCT-NO
                   PERFORM APPLY-TRANSACTION
                   MOVE 'Y' TO WS-TRANSACTION-FOUND
                   PERFORM READ-TRANSACTION
               ELSE
                   IF WS-TRAN-ACCT-NO > M-ACCT-NO
                       EXIT PERFORM
                   ELSE
                       PERFORM READ-TRANSACTION
                   END-IF
               END-IF
           END-PERFORM.

       APPLY-TRANSACTION.
           EVALUATE WS-TRAN-TRAN-CD
               WHEN '01'
                   ADD WS-TRAN-TRAN-AMT TO M-BALANCE
                   PERFORM REPORT-TRANSACTION 'DEPOSIT'
               WHEN '02'
                   SUBTRACT WS-TRAN-TRAN-AMT FROM M-BALANCE
                   PERFORM REPORT-TRANSACTION 'WITHDRAWAL'
               WHEN '03'
                   SUBTRACT WS-TRAN-TRAN-AMT FROM M-BALANCE
                   PERFORM REPORT-TRANSACTION 'FEE'
               WHEN OTHER
                   PERFORM REPORT-TRANSACTION 'UNKNOWN'
           END-EVALUATE
           MOVE WS-RUN-DATE TO M-LAST-ACT-DATE.

       REPORT-TRANSACTION.
           * Argument: TRAN-TYPE in literal
           MOVE M-ACCT-NO TO WS-RPT-ACCT-NO
           MOVE M-NAME TO WS-RPT-NAME
           MOVE M-BALANCE TO WS-RPT-BAL
           MOVE WS-RUN-DATE TO WS-RPT-DATE
           STRING
               "UPDATED-" DELIMITED BY SIZE
               ARGUMENT-1 DELIMITED BY SIZE
               INTO WS-RPT-STATUS
           END-STRING
           PERFORM WRITE-REPORT-LINE.

       REPORT-NO-TRANSACTION.
           MOVE M-ACCT-NO TO WS-RPT-ACCT-NO
           MOVE M-NAME TO WS-RPT-NAME
           MOVE M-BALANCE TO WS-RPT-BAL
           MOVE 'NO TRANSACTIONS' TO WS-RPT-STATUS
           MOVE WS-RUN-DATE TO WS-RPT-DATE
           PERFORM WRITE-REPORT-LINE.

       WRITE-REPORT-LINE.
           MOVE WS-RPT-ACCT-NO TO ACCT-REPORT-REC(1:10)
           MOVE WS-RPT-NAME TO ACCT-REPORT-REC(11:40)
           MOVE WS-RPT-BAL TO ACCT-REPORT-REC(41:50)
           MOVE WS-RPT-STATUS TO ACCT-REPORT-REC(51:70)
           MOVE WS-RPT-DATE TO ACCT-REPORT-REC(71:78)
           WRITE ACCT-REPORT-REC.

       WRITE-MASTER-OUT.
           MOVE M-ACCT-NO TO ACCT-MASTER-OUT-REC(1:10)
           MOVE M-NAME TO ACCT-MASTER-OUT-REC(11:40)
           MOVE M-BALANCE TO ACCT-MASTER-OUT-REC(41:50)
           MOVE M-LAST-ACT-DATE TO ACCT-MASTER-OUT-REC(51:58)
           WRITE ACCT-MASTER-OUT-REC.

       FINALIZE-SECTION.
           PERFORM WRITE-SUMMARY
           CLOSE ACCT-MASTER-IN
           CLOSE ACCT-TRAN-IN
           CLOSE ACCT-MASTER-OUT
           CLOSE ACCT-REPORT-OUT.

       WRITE-SUMMARY.
           MOVE SPACES TO ACCT-REPORT-REC
           STRING
               "TOTAL ACCOUNTS: " DELIMITED BY SIZE
               WS-TOTAL-ACCTS DELIMITED BY SIZE
               "  UPDATED: " DELIMITED BY SIZE
               WS-UPDATED-ACCTS DELIMITED BY SIZE
               "  NO TRANSACTIONS: " DELIMITED BY SIZE
               WS-NO-TRAN-ACCTS DELIMITED BY SIZE
               INTO ACCT-REPORT-REC
           END-STRING
           WRITE ACCT-REPORT-REC.

       END PROGRAM ACCTUPDT-REFACTORED.
